<!DOCTYPE html>
<html lang="gl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Cualificacións</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background-color: #fff;
            padding: 25px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .file-input-area {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 20px;
            background-color: #ecf0f1;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        input[type="file"] {
            flex-grow: 1;
        }

        button#analizarBtn {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            background-color: #3498db;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button#analizarBtn:hover {
            background-color: #2980b9;
        }

        button#analizarBtn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        /* Estilos de Pestanas */
        .tab-container {
            border-bottom: 2px solid #d0d0d0;
            display: flex;
        }

        .tab-btn {
            padding: 12px 22px;
            cursor: pointer;
            border: 2px solid #d0d0d0;
            border-bottom: none;
            background-color: #e9e9e9;
            font-size: 16px;
            margin-right: 5px;
            border-radius: 8px 8px 0 0;
            position: relative;
            top: 2px;
            color: #555;
        }

        .tab-btn.active {
            background-color: #fff;
            border-bottom-color: #fff;
            font-weight: bold;
            color: #3498db;
        }

        .tab-content-wrapper {
            border: 2px solid #d0d0d0;
            border-top: none;
            padding: 20px;
            border-radius: 0 0 8px 8px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Estilos para táboas */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }

        .summary-table th,
        .summary-table td {
            border: 1px solid #a2a2a2;
            padding: 10px;
            text-align: center;
            vertical-align: middle;
        }

        .summary-table thead th {
            background-color: #e0e0e0;
            font-weight: bold;
        }

        .summary-table .left-align-cell {
            text-align: left;
            background-color: #fff;
            vertical-align: top;
        }

        /* Estilos específicos para a táboa do Informe FP */
        .fp-table .main-header {
            background-color: #6c757d;
            color: white;
            font-size: 1.1em;
        }

        .fp-table .sub-header {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Analizador de Cualificacións</h1>
        <p>Seleccione o ficheiro CSV resultado de xerar o <strong>Informe Predefinido Xade: AL080-Listaxe
                cualificacións</strong>
            para xerar os informes estatísticos.</p>
        <div class="file-input-area">
            <input type="file" id="csvFileInput" accept=".csv">
            <button id="analizarBtn" disabled>Analizar Ficheiro</button>
        </div>
        <div id="informesContainer" style="display: none;">
            <div class="tab-container">
                <button class="tab-btn active" data-tab="informeModulos">Resumo Módulos</button>
                <button class="tab-btn" data-tab="informeAlumnado">Resumo Alumnado</button>
                <button class="tab-btn" data-tab="informeFP">Suspensos por Módulo</button>
                <button class="tab-btn" data-tab="informeSuspensos">Suspensos por Alumno/a</button>
            </div>
            <div class="tab-content-wrapper">
                <div id="informeModulos" class="tab-content active"></div>
                <div id="informeAlumnado" class="tab-content"></div>
                <div id="informeFP" class="tab-content"></div>
                <div id="informeSuspensos" class="tab-content"></div>
            </div>
        </div>
        <div id="mensaxeInicial">
            <p>Os resultados da análise amosaranse aquí...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const csvFileInput = document.getElementById('csvFileInput');
            const analizarBtn = document.getElementById('analizarBtn');
            const informesContainer = document.getElementById('informesContainer');
            const mensaxeInicial = document.getElementById('mensaxeInicial');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            csvFileInput.addEventListener('change', () => {
                analizarBtn.disabled = csvFileInput.files.length === 0;
            });

            analizarBtn.addEventListener('click', () => {
                const file = csvFileInput.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evento) => procesarContidoCSV(evento.target.result);
                reader.onerror = () => mensaxeInicial.innerHTML = `<p style="color:red;"><b>Erro:</b> Non se puido ler o ficheiro.</p>`;
                reader.readAsText(file, 'UTF-8');
            });

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(button.dataset.tab).classList.add('active');
                });
            });

            function xerarIniciais(nomeCompleto) {
                const stopWords = new Set(['de', 'e', 'a', 'o', 'para', 'ao', 'á', 'i']);
                return nomeCompleto.replace(/[()]/g, '').split(' ')
                    .filter(palabra => !stopWords.has(palabra.toLowerCase()) && palabra.length > 0)
                    .map(palabra => palabra[0]).join('').toUpperCase();
            }

            function procesarContidoCSV(contenido) {
                const estadisticasModulos = {};
                const datosPorAlumno = {};
                let infoCiclo = { nome: '', curso: '' };
                const lineas = contenido.split('\n').filter(linea => linea.trim() !== '');

                if (lineas.length < 2) {
                    mensaxeInicial.innerHTML = "<p>O ficheiro está baleiro ou só contén a cabeceira.</p>";
                    return;
                }
                const cabecera = lineas[0].split(';').map(h => h.replace(/^"|"$/g, '').trim());
                const datos = lineas.slice(1);

                const idxDoi = cabecera.indexOf('Nº DOI');
                const idxApelido1 = cabecera.indexOf('1º APELIDO');
                const idxApelido2 = cabecera.indexOf('2º APELIDO');
                const idxNome = cabecera.indexOf('NOME');
                const idxMateria = cabecera.indexOf('MATERIA');
                const idxCualificacion = cabecera.indexOf('CUALIFICACIÓN');
                const idxCurso = cabecera.indexOf('CURSO');

                if ([idxDoi, idxNome, idxMateria, idxCualificacion, idxApelido1, idxApelido2, idxCurso].includes(-1)) {
                    mensaxeInicial.innerHTML = `<p style="color:red;"><b>Erro:</b> Faltan columnas esenciais no ficheiro CSV.</p>`;
                    return;
                }

                for (const linea of datos) {
                    const campos = linea.split(';').map(c => c.replace(/^"|"$/g, '').trim());
                    const doi = campos[idxDoi];
                    const materia = campos[idxMateria];
                    const cualificacionStr = campos[idxCualificacion];

                    if (!doi || !materia) continue;

                    if (!infoCiclo.curso) {
                        infoCiclo.curso = campos[idxCurso];
                    }

                    if (!estadisticasModulos[materia]) {
                        estadisticasModulos[materia] = { matriculados: 0, avaliados: 0, aprobados: 0, suspensos: 0 };
                    }
                    estadisticasModulos[materia].matriculados++;

                    if (!datosPorAlumno[doi]) {
                        const apelidos = [campos[idxApelido1], campos[idxApelido2]].filter(Boolean).join(' ');
                        const nomeCompleto = apelidos ? `${apelidos}, ${campos[idxNome]}` : campos[idxNome];
                        datosPorAlumno[doi] = { nomeCompleto, suspensos: 0, avaliados: 0 };
                    }

                    if (cualificacionStr.toLowerCase() !== 'sen cualificar' && cualificacionStr !== '') {
                        const nota = parseInt(cualificacionStr, 10);
                        if (!isNaN(nota)) {
                            estadisticasModulos[materia].avaliados++;
                            nota >= 5 ? estadisticasModulos[materia].aprobados++ : estadisticasModulos[materia].suspensos++;
                            datosPorAlumno[doi].avaliados++;
                            if (nota < 5) datosPorAlumno[doi].suspensos++;
                        }
                    }
                }

                informesContainer.style.display = 'block';
                mensaxeInicial.style.display = 'none';

                document.getElementById('informeModulos').innerHTML = xerarInformeModulos(estadisticasModulos);
                document.getElementById('informeAlumnado').innerHTML = xerarInformeAlumnado(datosPorAlumno);
                document.getElementById('informeFP').innerHTML = xerarInformeFP(estadisticasModulos, infoCiclo);
                document.getElementById('informeSuspensos').innerHTML = xerarInformeSuspensos(datosPorAlumno);
                tabButtons[0].click();
            }

            function xerarInformeModulos(estadisticas) {
                let tablaHTML = `<table class="summary-table"><thead><tr><th rowspan="2">1º CURSO<br>Módulo</th><th>Alumnos matriculados inicialmente</th><th>Alumnos avaliados</th><th colspan="2">Alumnos con avaliación positiva</th><th colspan="2">Alumnos con avaliación negativa</th></tr><tr><th>Total</th><th>Total</th><th>Total</th><th>%</th><th>Total</th><th>%</th></tr></thead><tbody>`;
                for (const materia in estadisticas) { const stats = estadisticas[materia]; const porcAprobados = stats.avaliados > 0 ? (stats.aprobados / stats.avaliados * 100).toFixed(2) : "0.00"; const porcSuspensos = stats.avaliados > 0 ? (stats.suspensos / stats.avaliados * 100).toFixed(2) : "0.00"; tablaHTML += `<tr><td class="left-align-cell">${materia}</td><td>${stats.matriculados}</td><td>${stats.avaliados}</td><td>${stats.aprobados}</td><td>${porcAprobados}</td><td>${stats.suspensos}</td><td>${porcSuspensos}</td></tr>`; }
                return tablaHTML + `</tbody></table>`;
            }

            function xerarInformeAlumnado(datosAlumnado) {
                const resumo = { aprobaTodo: [], suspende1: [], suspende2: [], suspende3: [], suspende4: [], suspende5ouMais: [] }; for (const doi in datosAlumnado) { const alumno = datosAlumnado[doi]; if (alumno.avaliados > 0) { switch (alumno.suspensos) { case 0: resumo.aprobaTodo.push(alumno.nomeCompleto); break; case 1: resumo.suspende1.push(alumno.nomeCompleto); break; case 2: resumo.suspende2.push(alumno.nomeCompleto); break; case 3: resumo.suspende3.push(alumno.nomeCompleto); break; case 4: resumo.suspende4.push(alumno.nomeCompleto); break; default: resumo.suspende5ouMais.push(alumno.nomeCompleto); break; } } }
                for (const categoria in resumo) { resumo[categoria].sort((a, b) => a.localeCompare(b, 'gl')); }
                return `<table class="summary-table"><thead><tr><th>Situación do Alumnado</th><th>Nº de Alumnos/as</th><th>Listaxe de Alumnado</th></tr></thead><tbody><tr><td class="left-align-cell">Aproba todos os módulos cualificados</td><td>${resumo.aprobaTodo.length}</td><td class="left-align-cell">${resumo.aprobaTodo.join('<br>')}</td></tr><tr><td class="left-align-cell">Suspende 1 módulo</td><td>${resumo.suspende1.length}</td><td class="left-align-cell">${resumo.suspende1.join('<br>')}</td></tr><tr><td class="left-align-cell">Suspende 2 módulos</td><td>${resumo.suspende2.length}</td><td class="left-align-cell">${resumo.suspende2.join('<br>')}</td></tr><tr><td class="left-align-cell">Suspende 3 módulos</td><td>${resumo.suspende3.length}</td><td class="left-align-cell">${resumo.suspende3.join('<br>')}</td></tr><tr><td class="left-align-cell">Suspende 4 módulos</td><td>${resumo.suspende4.length}</td><td class="left-align-cell">${resumo.suspende4.join('<br>')}</td></tr><tr><td class="left-align-cell">Suspende 5 ou máis módulos</td><td>${resumo.suspende5ouMais.length}</td><td class="left-align-cell">${resumo.suspende5ouMais.join('<br>')}</td></tr></tbody></table>`;
            }

            function xerarInformeFP(estadisticas, infoCiclo) {
                const modulosConSuspensos = Object.keys(estadisticas).filter(
                    materia => estadisticas[materia].suspensos > 0
                );

                if (modulosConSuspensos.length === 0) {
                    return '<p>Non se atoparon módulos con alumnos/as con avaliación negativa.</p>';
                }

                const numModulosFiltrados = modulosConSuspensos.length;
                const colspanModulos = numModulosFiltrados * 2;
                const colspanTotal = colspanModulos + 2;

                let headerMaterias = '';
                let headerNumPorc = '';
                modulosConSuspensos.forEach(materia => {
                    headerMaterias += `<th colspan="2">${xerarIniciais(materia)}</th>`;
                    headerNumPorc += `<th>Nº</th><th>%</th>`;
                });

                let filaTotalAlumnos = '';
                let filaAprobados = '';
                let filaSuspensos = '';

                modulosConSuspensos.forEach(materia => {
                    const stats = estadisticas[materia];
                    const totalAvaliados = stats.avaliados;
                    const porcAprobados = totalAvaliados > 0 ? (stats.aprobados / totalAvaliados * 100).toFixed(2) : '0.00';
                    const porcSuspensos = totalAvaliados > 0 ? (stats.suspensos / totalAvaliados * 100).toFixed(2) : '0.00';

                    filaTotalAlumnos += `<td>${totalAvaliados}</td><td></td>`;
                    filaAprobados += `<td>${stats.aprobados}</td><td>${porcAprobados}</td>`;
                    filaSuspensos += `<td>${stats.suspensos}</td><td>${porcSuspensos}</td>`;
                });

                return `<table class="summary-table fp-table">
                    <thead>
                        <tr><th class="main-header" colspan="${colspanTotal}">Aprobados e Suspensos por Módulo</th></tr>
                        <tr>
                            <th class="sub-header" colspan="2">CICLO</th>
                            <th class="sub-header" colspan="${colspanModulos}">${infoCiclo.curso}</th>
                        </tr>
                        <tr>
                            <th class="sub-header" colspan="2">CURSO</th>
                            ${headerMaterias}
                        </tr>
                        <tr>
                            <th colspan="2"></th>
                            ${headerNumPorc}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td rowspan="3" style="font-weight: bold;">${infoCiclo.curso.split('º')[0]}º</td>
                            <td class="left-align-cell">Nº total de alumnos</td>
                            ${filaTotalAlumnos}
                        </tr>
                        <tr>
                            <td class="left-align-cell">Alumnos con avaliación positiva</td>
                            ${filaAprobados}
                        </tr>
                        <tr>
                            <td class="left-align-cell">Alumnos con avaliación negativa</td>
                            ${filaSuspensos}
                        </tr>
                    </tbody>
                </table>`;
            }

            function xerarInformeSuspensos(datosAlumnado) {
                // Contador de alumnado por número de suspensos
                const contadorSuspensos = {
                    0: 0,  // Todos aprobados
                    1: 0,  // 1 suspenso
                    2: 0,  // 2 suspensos
                    3: 0,  // 3 suspensos
                    4: 0,  // 4 suspensos
                    '5+': 0, // 5 ou máis suspensos
                    'todos': 0 // Todos suspensos
                };

                let totalAlumnos = 0;
                let totalModulosAvaliados = 0;

                // Contar por número de suspensos
                for (const doi in datosAlumnado) {
                    const alumno = datosAlumnado[doi];
                    totalAlumnos++;
                    totalModulosAvaliados += alumno.avaliados;

                    if (alumno.avaliados > 0) {
                        if (alumno.suspensos === 0) {
                            contadorSuspensos[0]++;
                        } else if (alumno.suspensos === 1) {
                            contadorSuspensos[1]++;
                        } else if (alumno.suspensos === 2) {
                            contadorSuspensos[2]++;
                        } else if (alumno.suspensos === 3) {
                            contadorSuspensos[3]++;
                        } else if (alumno.suspensos === 4) {
                            contadorSuspensos[4]++;
                        } else {
                            contadorSuspensos['5+']++;
                        }

                        // Verificar se suspendeu todos os módulos avaliados
                        if (alumno.suspensos === alumno.avaliados && alumno.avaliados > 0) {
                            contadorSuspensos['todos']++;
                        }
                    }
                }

                // Calcular porcentaxes
                const porcentaxes = {};
                for (const key in contadorSuspensos) {
                    porcentaxes[key] = totalAlumnos > 0 ? ((contadorSuspensos[key] / totalAlumnos) * 100).toFixed(2) : '0.00';
                }

                // Xerar a táboa HTML
                let html = `<table class="summary-table" style="margin-top: 20px;">
        <thead>
            <tr><th class="main-header" colspan="3">Suspensos por Alumno/a</th></tr>
            <tr>
                <th>ALUMNADO CON X MATERIAS SUSPENSAS</th>
                <th>Nº de Alumnos/as</th>
                <th>% sobre o total</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="left-align-cell">ALUMNADO CON TODAS AS MATERIAS/MÓDULOS APROBADAS/OS</td>
                <td>${contadorSuspensos[0]}</td>
                <td>${porcentaxes[0]}%</td>
            </tr>
            <tr>
                <td class="left-align-cell">ALUMNADO CON SÓ 1 MATERIA/MÓDULO SUSPENSA/O</td>
                <td>${contadorSuspensos[1]}</td>
                <td>${porcentaxes[1]}%</td>
            </tr>
            <tr>
                <td class="left-align-cell">ALUMNADO CON 2 MATERIAS/MÓDULOS SUSPENSAS/OS</td>
                <td>${contadorSuspensos[2]}</td>
                <td>${porcentaxes[2]}%</td>
            </tr>
            <tr>
                <td class="left-align-cell">ALUMNADO CON 3 MATERIAS/MÓDULOS SUSPENSAS/OS</td>
                <td>${contadorSuspensos[3]}</td>
                <td>${porcentaxes[3]}%</td>
            </tr>
            <tr>
                <td class="left-align-cell">ALUMNADO CON 4 MATERIAS/MÓDULOS SUSPENSAS/OS</td>
                <td>${contadorSuspensos[4]}</td>
                <td>${porcentaxes[4]}%</td>
            </tr>
            <tr>
                <td class="left-align-cell">ALUMNADO CON 5 OU MÁIS MATERIAS/MÓDULOS SUSPENSAS/OS</td>
                <td>${contadorSuspensos['5+']}</td>
                <td>${porcentaxes['5+']}%</td>
            </tr>
            <tr>
                <td class="left-align-cell">ALUMNADO CON TODAS AS MATERIAS/MÓDULOS SUSPENSAS/OS</td>
                <td>${contadorSuspensos['todos']}</td>
                <td>${porcentaxes['todos']}%</td>
            </tr>
        </tbody>
    </table>`;

                // Engadir información do total
                html += `<div style="margin-top: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
        <strong>TOTAL ALUMNOS/AS DO GRUPO:</strong> ${totalAlumnos}<br>
        <strong>Total calificacións analizadas:</strong> ${totalModulosAvaliados}<br>
        <strong>Media de módulos avaliados por alumno/a:</strong> ${(totalModulosAvaliados / totalAlumnos).toFixed(2)}
    </div>`;

                return html;
            }

        });

    </script>
</body>

</html>